{{template "base.html" .}}

{{define "content"}}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">
                                <i class="fas fa-comments me-2"></i>Canlı Destek
                            </h4>
                            <small>Sorularınız için 7/24 buradayız!</small>
                        </div>
                        <div>
                            <button id="videoCallBtn" class="btn btn-light btn-sm me-2" title="Görüntülü Görüşmeye Geç">
                                <i class="fas fa-video me-1"></i>Görüntülü Görüşme
                            </button>
                            <button id="endCallBtn" class="btn btn-danger btn-sm" style="display: none;" title="Görüşmeyi Sonlandır">
                                <i class="fas fa-phone-slash me-1"></i>Sonlandır
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- Video Call Area -->
                    <div id="videoCallArea" class="video-call-area" style="display: none; height: 300px; background: #000; position: relative;">
                        <video id="localVideo" autoplay muted style="width: 150px; height: 100px; position: absolute; top: 10px; right: 10px; border: 2px solid #fff; border-radius: 8px; z-index: 10;"></video>
                        <video id="remoteVideo" autoplay style="width: 100%; height: 100%; object-fit: cover;"></video>
                        <div class="video-controls" style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 10;">
                            <button id="toggleMuteBtn" class="btn btn-secondary btn-sm me-2" title="Mikrofonu Aç/Kapat">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button id="toggleVideoBtn" class="btn btn-secondary btn-sm me-2" title="Kamerayı Aç/Kapat">
                                <i class="fas fa-video"></i>
                            </button>
                            <button id="endCallBtnVideo" class="btn btn-danger btn-sm" onclick="endVideoCall()" title="Görüşmeyi Sonlandır">
                                <i class="fas fa-phone-slash me-1"></i>Sonlandır
                            </button>
                        </div>
                        <div class="call-status" style="position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                            <i class="fas fa-circle text-success me-1" style="font-size: 8px;"></i>
                            <span id="callStatusText">Bağlantı kuruluyor...</span>
                        </div>
                    </div>
                    
                    <!-- Chat Messages Area -->
                    <div id="chatMessages" class="chat-messages" style="height: 400px; overflow-y: auto; padding: 20px; background: #f8f9fa;">
                        <div class="text-center text-muted">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>Merhaba! Size nasıl yardımcı olabiliriz?</p>
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="chat-input border-top p-3">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Mesajınızı yazın..." maxlength="500">
                            <button class="btn btn-primary" id="sendButton" type="button">
                                <i class="fas fa-paper-plane"></i> Gönder
                            </button>
                        </div>
                        <small class="text-muted">Enter tuşuna basarak da mesaj gönderebilirsiniz</small>
                    </div>
                </div>
            </div>
            
            <!-- Support Info -->
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Destek Saatleri:</strong> 7/24 online destek hizmeti veriyoruz. 
                Mesajlarınız en kısa sürede yanıtlanacaktır.
            </div>
            
            <!-- Safari Compatibility Info -->
            <div id="safariInfo" class="alert alert-warning mt-2" style="display: none;">
                <i class="fas fa-safari me-2"></i>
                <strong>Safari Kullanıcıları İçin:</strong>
                <ul class="mb-0 mt-2">
                    <li>iOS 11.3+ veya macOS High Sierra+ gereklidir</li>
                    <li>Kamera ve mikrofon izni vermeniz gerekecek</li>
                    <li>Yerel ağda test için: <code>http://192.168.1.133:9394</code></li>
                    <li>Sorun yaşarsanız Chrome veya Firefox deneyebilirsiniz</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
.chat-messages {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}

.message {
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.user {
    text-align: right;
}

.message.admin {
    text-align: left;
}

.message-bubble {
    display: inline-block;
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    position: relative;
}

.message.user .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 4px;
}

.message.admin .message-bubble {
    background: white;
    color: #333;
    border: 1px solid #e0e0e0;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 5px;
}

.message.user .message-time {
    text-align: right;
    color: #fff;
}

.message.admin .message-time {
    text-align: left;
    color: #666;
}

.typing-indicator {
    text-align: left;
    margin-bottom: 15px;
}

.typing-bubble {
    display: inline-block;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 18px;
    padding: 12px 16px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}

.chat-input {
    background: white;
}

#messageInput:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.online-status {
    display: inline-block;
    width: 10px;
    height: 10px;
    background: #4CAF50;
    border-radius: 50%;
    margin-right: 5px;
    animation: blink 2s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

/* Video Call Styles */
.video-call-area {
    border-bottom: 1px solid #dee2e6;
}

.video-controls button {
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.video-controls button.muted {
    background-color: #dc3545;
    border-color: #dc3545;
}

.video-controls button.video-off {
    background-color: #dc3545;
    border-color: #dc3545;
}

#localVideo {
    cursor: pointer;
    transition: all 0.3s ease;
}

#localVideo:hover {
    transform: scale(1.05);
}

.call-status {
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
}

/* Responsive video */
@media (max-width: 768px) {
    #localVideo {
        width: 100px;
        height: 75px;
    }
    
    .video-controls button {
        width: 35px;
        height: 35px;
    }
    
    /* Safari mobile specific */
    .video-call-area {
        height: 250px !important;
    }
    
    .chat-messages {
        height: 180px !important;
    }
}

/* Safari-specific styles */
@supports (-webkit-appearance: none) {
    #localVideo, #remoteVideo {
        -webkit-playsinline: true;
        -webkit-transform: translateZ(0);
        backface-visibility: hidden;
    }
    
    .video-call-area {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
    }
    
    #videoCallBtn {
        -webkit-appearance: none;
        border-radius: 6px;
    }
}

/* iOS Safari specific */
@supports (-webkit-touch-callout: none) {
    .video-controls {
        padding-bottom: 20px; /* Account for iOS home indicator */
    }
    
    .chat-input {
        padding-bottom: 25px; /* Account for iOS keyboard */
    }
    
    #messageInput {
        font-size: 16px; /* Prevent zoom on iOS */
    }
}
</style>

<script>
let sessionID = '{{.sessionID}}';
let lastMessageTime = null;
let pollInterval;

// Video Call Variables
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let isCallActive = false;
let isMuted = false;
let isVideoOff = false;

// DOM Elements
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const videoCallBtn = document.getElementById('videoCallBtn');
const endCallBtn = document.getElementById('endCallBtn');
const videoCallArea = document.getElementById('videoCallArea');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const toggleMuteBtn = document.getElementById('toggleMuteBtn');
const toggleVideoBtn = document.getElementById('toggleVideoBtn');
const callStatusText = document.getElementById('callStatusText');

// Initialize chat
document.addEventListener('DOMContentLoaded', function() {
    loadMessages();
    startPolling();
    
    // Check video call permissions on load
    updateVideoCallButton();
    
    // Show Safari info if using Safari
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    if (isSafari) {
        const safariInfo = document.getElementById('safariInfo');
        if (safariInfo) {
            safariInfo.style.display = 'block';
        }
    }
    
    // Send message on button click
    sendButton.addEventListener('click', sendMessage);
    
    // Send message on Enter key
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Focus on input
    messageInput.focus();
    
    // Video call event listeners
    videoCallBtn.addEventListener('click', startVideoCall);
    endCallBtn.addEventListener('click', endVideoCall);
    toggleMuteBtn.addEventListener('click', toggleMute);
    toggleVideoBtn.addEventListener('click', toggleVideo);
    
    // Test WebRTC after page loads
    setTimeout(() => {
        testWebRTC().then(success => {
            if (success) {
                console.log('🎉 WebRTC tamamen uyumlu');
            } else {
                console.warn('⚠️ WebRTC uyumluluk sorunu');
            }
        });
    }, 1000);
});

// Load existing messages
function loadMessages() {
    fetch('/support/messages', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayMessages(data.messages);
        }
    })
    .catch(error => {
        console.error('Error loading messages:', error);
    });
}

// Send message
function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Disable input while sending
    messageInput.disabled = true;
    sendButton.disabled = true;
    
    fetch('/support/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            addMessage(data.message);
            scrollToBottom();
        } else {
            alert('Mesaj gönderilemedi: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert('Mesaj gönderilirken hata oluştu');
    })
    .finally(() => {
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    });
}

// Display messages
function displayMessages(messages) {
    // Clear loading message
    chatMessages.innerHTML = '';
    
    if (messages && messages.length > 0) {
        messages.forEach(message => {
            addMessage(message);
        });
        scrollToBottom();
    } else {
        showWelcomeMessage();
    }
}

// Add single message
function addMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.is_admin ? 'admin' : 'user'}`;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'message-bubble';
    bubbleDiv.textContent = message.message;
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    const messageTime = new Date(message.created_at);
    timeDiv.textContent = messageTime.toLocaleTimeString('tr-TR', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    messageDiv.appendChild(bubbleDiv);
    messageDiv.appendChild(timeDiv);
    chatMessages.appendChild(messageDiv);
    
    // Update last message time
    lastMessageTime = message.created_at;
}

// Show welcome message
function showWelcomeMessage() {
    chatMessages.innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-comments fa-3x mb-3"></i>
            <p>Merhaba! Size nasıl yardımcı olabiliriz?</p>
            <div class="online-status"></div>
            <small>Destek ekibimiz online</small>
        </div>
    `;
}

// Scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Start polling for new messages
function startPolling() {
    pollInterval = setInterval(() => {
        loadMessages();
    }, 3000); // Poll every 3 seconds
}

// Stop polling when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        clearInterval(pollInterval);
    } else {
        startPolling();
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    clearInterval(pollInterval);
    if (isCallActive) {
        endVideoCall();
    }
});

// Check and request media permissions
async function checkAndRequestPermissions() {
    console.log('🔐 İzin kontrolü başlatılıyor...');
    
    try {
        // Check if permissions API is supported
        if (navigator.permissions && navigator.permissions.query) {
            console.log('✅ Permissions API destekleniyor');
            
            // Check camera permission
            const cameraPermission = await navigator.permissions.query({ name: 'camera' });
            console.log('📹 Kamera izni durumu:', cameraPermission.state);
            
            // Check microphone permission
            const micPermission = await navigator.permissions.query({ name: 'microphone' });
            console.log('🎤 Mikrofon izni durumu:', micPermission.state);
            
            // If permissions are denied, show specific message
            if (cameraPermission.state === 'denied' || micPermission.state === 'denied') {
                throw new Error('PERMISSION_DENIED');
            }
            
            // If permissions are prompt, we'll request them
            if (cameraPermission.state === 'prompt' || micPermission.state === 'prompt') {
                console.log('⏳ İzinler istenecek...');
            }
        } else {
            console.log('⚠️ Permissions API desteklenmiyor, getUserMedia ile test edilecek');
        }
        
        return true;
        
    } catch (error) {
        console.error('❌ İzin kontrolü hatası:', error);
        throw error;
    }
}

// Enhanced video call start function
async function startVideoCall() {
    try {
        console.log('🎥 Video görüşme başlatılıyor...');
        
        // Step 1: Check WebRTC support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('WebRTC desteklenmiyor. Lütfen modern bir tarayıcı kullanın.');
        }
        
        if (!window.RTCPeerConnection) {
            throw new Error('RTCPeerConnection desteklenmiyor. Lütfen modern bir tarayıcı kullanın.');
        }
        
        console.log('✅ WebRTC desteği kontrol edildi');
        
        // Step 2: Check permissions first
        await checkAndRequestPermissions();
        
        // Step 3: Request media with progressive constraints
        console.log('📹 Kamera ve mikrofon erişimi isteniyor...');
        
        // Try with ideal constraints first
        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280, min: 640 },
                    height: { ideal: 720, min: 480 },
                    facingMode: 'user'
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            console.log('✅ İdeal ayarlarla medya erişimi başarılı');
        } catch (mediaError) {
            console.log('⚠️ İdeal ayarlar başarısız, basit ayarlarla deneniyor...');
            
            // Fallback to basic constraints
            localStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });
            console.log('✅ Basit ayarlarla medya erişimi başarılı');
        }
        
        // Step 4: Set up video elements
        localVideo.srcObject = localStream;
        
        // Safari-specific handling
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        if (isSafari) {
            localVideo.playsInline = true;
            localVideo.setAttribute('playsinline', '');
            localVideo.muted = true;
        }
        
        // Step 5: Show video call interface
        videoCallArea.style.display = 'block';
        videoCallBtn.style.display = 'none';
        endCallBtn.style.display = 'inline-block';
        
        // Adjust chat area height
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        chatMessages.style.height = isMobile ? '200px' : '300px';
        
        isCallActive = true;
        callStatusText.textContent = 'Görüntülü görüşme başlatıldı';
        
        // Step 6: Send request and initialize WebRTC
        console.log('📞 Video görüşme talebi gönderiliyor...');
        await sendVideoCallRequest();
        
        console.log('🔗 WebRTC peer connection başlatılıyor...');
        await initializePeerConnection();
        
        console.log('🔄 Signaling polling başlatılıyor...');
        startSignalingPolling();
        
        addSystemMessage('Görüntülü görüşme başlatıldı. Destek temsilcisi bağlantıyı kabul etmesini bekliyor...');
        console.log('✅ Video görüşme başarıyla başlatıldı');
        
    } catch (error) {
        console.error('❌ Video görüşme başlatılamadı:', error);
        
        let errorMessage = 'Video görüşme başlatılamadı. ';
        
        if (error.message === 'PERMISSION_DENIED') {
            errorMessage = 'Kamera ve mikrofon izinleri reddedildi. Lütfen tarayıcı ayarlarından izin verin ve sayfayı yenileyin.';
        } else if (error.name === 'NotAllowedError') {
            errorMessage = 'Kamera ve mikrofon izinleri reddedildi. Lütfen izin verin ve tekrar deneyin.';
        } else if (error.name === 'NotFoundError') {
            errorMessage = 'Kamera veya mikrofon bulunamadı. Lütfen cihazınızı kontrol edin.';
        } else if (error.name === 'NotReadableError') {
            errorMessage = 'Kamera veya mikrofon başka bir uygulama tarafından kullanılıyor. Lütfen diğer uygulamaları kapatın.';
        } else if (error.name === 'OverconstrainedError') {
            errorMessage = 'Kamera gereksinimleri karşılanamıyor. Lütfen farklı bir kamera deneyin.';
        } else if (error.name === 'TypeError') {
            errorMessage = 'WebRTC bağlantı hatası. Lütfen sayfayı yenileyin.';
        } else {
            errorMessage += 'Bilinmeyen bir hata oluştu. Lütfen sayfayı yenileyin.';
        }
        
        showPermissionDialog(errorMessage);
        callStatusText.textContent = 'Hata oluştu';
    }
}

async function endVideoCall() {
    try {
        // Stop local stream
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        // Close peer connection
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        
        // Hide video call area
        videoCallArea.style.display = 'none';
        videoCallBtn.style.display = 'inline-block';
        endCallBtn.style.display = 'none';
        
        // Reset chat area height
        chatMessages.style.height = '400px';
        
        // Reset video elements
        localVideo.srcObject = null;
        remoteVideo.srcObject = null;
        
        // Reset states
        isCallActive = false;
        isMuted = false;
        isVideoOff = false;
        
        // Stop signaling polling
        stopSignalingPolling();
        
        // Reset button states
        toggleMuteBtn.classList.remove('muted');
        toggleVideoBtn.classList.remove('video-off');
        toggleMuteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        toggleVideoBtn.innerHTML = '<i class="fas fa-video"></i>';
        
        // Send end call notification
        await sendVideoCallEnd();
        
        // Add system message
        addSystemMessage('Görüntülü görüşme sonlandırıldı.');
        
    } catch (error) {
        console.error('Video call sonlandırma hatası:', error);
    }
}

function toggleMute() {
    if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            isMuted = !audioTrack.enabled;
            
            if (isMuted) {
                toggleMuteBtn.classList.add('muted');
                toggleMuteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            } else {
                toggleMuteBtn.classList.remove('muted');
                toggleMuteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }
    }
}

function toggleVideo() {
    if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            isVideoOff = !videoTrack.enabled;
            
            if (isVideoOff) {
                toggleVideoBtn.classList.add('video-off');
                toggleVideoBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
            } else {
                toggleVideoBtn.classList.remove('video-off');
                toggleVideoBtn.innerHTML = '<i class="fas fa-video"></i>';
            }
        }
    }
}

// Initialize WebRTC Peer Connection
async function initializePeerConnection() {
    try {
        console.log('Customer initializing peer connection...');
        // Create peer connection with STUN servers
        peerConnection = new RTCPeerConnection({
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ]
        });
        console.log('Customer peer connection created');
        
        // Add local stream to peer connection
        if (localStream) {
            console.log('Customer adding local stream tracks to peer connection...');
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            console.log('Customer local stream tracks added');
        }
        
        // Handle remote stream
        peerConnection.ontrack = (event) => {
            console.log('Customer received remote stream');
            remoteStream = event.streams[0];
            remoteVideo.srcObject = remoteStream;
            callStatusText.textContent = 'Bağlantı kuruldu';
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                console.log('Customer sending ICE candidate to admin...');
                sendSignalingMessage({
                    type: 'ice-candidate',
                    candidate: event.candidate
                });
            }
        };
        
        // Handle connection state changes
        peerConnection.onconnectionstatechange = () => {
            console.log('Customer connection state:', peerConnection.connectionState);
            switch (peerConnection.connectionState) {
                case 'connected':
                    callStatusText.textContent = 'Bağlandı';
                    break;
                case 'disconnected':
                    callStatusText.textContent = 'Bağlantı kesildi';
                    break;
                case 'failed':
                    callStatusText.textContent = 'Bağlantı başarısız';
                    break;
            }
        };
        
        console.log('Customer peer connection initialized, waiting for admin acceptance...');
        
    } catch (error) {
        console.error('Customer peer connection initialization failed:', error);
    }
}

// Send signaling message to admin
async function sendSignalingMessage(message) {
    try {
        console.log('Customer sending signaling message:', message);
        const response = await fetch('/support/webrtc-signal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                message: message
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Customer signaling message failed:', data.error);
        } else {
            console.log('Customer signaling message sent successfully');
        }
    } catch (error) {
        console.error('Error sending customer signaling message:', error);
    }
}

// Handle incoming signaling messages
async function handleSignalingMessage(message) {
    try {
        console.log('Customer handling signaling message:', message);
        switch (message.type) {
            case 'offer':
                console.log('Customer received offer, setting remote description...');
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                console.log('Customer creating answer...');
                const answer = await peerConnection.createAnswer();
                console.log('Customer setting local description (answer)...');
                await peerConnection.setLocalDescription(answer);
                console.log('Customer sending answer to admin...');
                sendSignalingMessage({
                    type: 'answer',
                    answer: answer
                });
                break;
                
            case 'answer':
                console.log('Customer received answer, setting remote description...');
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                console.log('Customer remote description set successfully');
                break;
                
            case 'ice-candidate':
                console.log('Customer received ICE candidate, adding...');
                await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                console.log('Customer ICE candidate added successfully');
                break;
                
            case 'call-accepted':
                // Admin accepted the call, now create and send offer
                console.log('Call accepted by admin, creating offer...');
                const offer = await peerConnection.createOffer();
                console.log('Customer offer created, setting local description...');
                await peerConnection.setLocalDescription(offer);
                console.log('Customer sending offer to admin...');
                sendSignalingMessage({
                    type: 'offer',
                    offer: offer
                });
                addSystemMessage('Admin görüşmeyi kabul etti. Bağlantı kuruluyor...');
                break;
        }
    } catch (error) {
        console.error('Error handling signaling message:', error);
    }
}

async function sendVideoCallRequest() {
    try {
        console.log('Customer sending video call request for session:', sessionID);
        const response = await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                action: 'start'
            })
        });
        
        const data = await response.json();
        console.log('Customer video call request response:', data);
        if (!data.success) {
            console.error('Customer video call request failed:', data.error);
        } else {
            console.log('Customer video call request sent successfully');
        }
    } catch (error) {
        console.error('Customer error sending video call request:', error);
    }
}

async function sendVideoCallEnd() {
    try {
        const response = await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                action: 'end'
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Video call end failed:', data.error);
        }
    } catch (error) {
        console.error('Error sending video call end:', error);
    }
}

function addSystemMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message system';
    messageDiv.style.textAlign = 'center';
    messageDiv.style.marginBottom = '15px';
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.style.display = 'inline-block';
    bubbleDiv.style.background = '#17a2b8';
    bubbleDiv.style.color = 'white';
    bubbleDiv.style.padding = '8px 16px';
    bubbleDiv.style.borderRadius = '15px';
    bubbleDiv.style.fontSize = '0.9em';
    bubbleDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i>' + message;
    
    messageDiv.appendChild(bubbleDiv);
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

// Show permission dialog with better UI
function showPermissionDialog(message) {
    // Remove existing dialog if any
    const existingDialog = document.getElementById('permissionDialog');
    if (existingDialog) {
        existingDialog.remove();
    }
    
    // Create dialog
    const dialog = document.createElement('div');
    dialog.id = 'permissionDialog';
    dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        font-family: 'Poppins', sans-serif;
    `;
    
    const dialogContent = document.createElement('div');
    dialogContent.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
    `;
    
    // Add CSS animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    // Create icon based on error type
    let icon = '❌';
    if (message.includes('izin')) icon = '🔐';
    else if (message.includes('kamera')) icon = '📹';
    else if (message.includes('mikrofon')) icon = '🎤';
    else if (message.includes('WebRTC')) icon = '🔗';
    
    dialogContent.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">${icon}</div>
        <h3 style="color: #333; margin-bottom: 15px; font-weight: 600;">Kamera ve Mikrofon İzni Gerekli</h3>
        <p style="color: #666; line-height: 1.6; margin-bottom: 25px; font-size: 14px;">${message}</p>
        
        <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 25px; text-align: left;">
            <h4 style="color: #333; margin-bottom: 10px; font-size: 16px;">🔧 Çözüm Adımları:</h4>
            <ol style="color: #666; font-size: 14px; line-height: 1.8; margin: 0; padding-left: 20px;">
                <li>Tarayıcı adres çubuğundaki <strong>🔒</strong> simgesine tıklayın</li>
                <li><strong>"Kamera"</strong> ve <strong>"Mikrofon"</strong> seçeneklerini <strong>"İzin Ver"</strong> yapın</li>
                <li>Sayfayı yenileyin (F5)</li>
                <li>"Görüntülü Görüşme" butonuna tekrar tıklayın</li>
            </ol>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="retryBtn" style="
                background: #007bff;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 500;
                transition: all 0.3s ease;
            " onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                🔄 Tekrar Dene
            </button>
            <button id="closeBtn" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 500;
                transition: all 0.3s ease;
            " onmouseover="this.style.background='#545b62'" onmouseout="this.style.background='#6c757d'">
                ❌ Kapat
            </button>
        </div>
    `;
    
    dialog.appendChild(dialogContent);
    document.body.appendChild(dialog);
    
    // Add event listeners
    document.getElementById('retryBtn').addEventListener('click', () => {
        dialog.remove();
        setTimeout(() => startVideoCall(), 500);
    });
    
    document.getElementById('closeBtn').addEventListener('click', () => {
        dialog.remove();
    });
    
    // Close on background click
    dialog.addEventListener('click', (e) => {
        if (e.target === dialog) {
            dialog.remove();
        }
    });
    
    // Close on Escape key
    document.addEventListener('keydown', function closeOnEscape(e) {
        if (e.key === 'Escape') {
            dialog.remove();
            document.removeEventListener('keydown', closeOnEscape);
        }
    });
}

// Signaling polling
let signalingPollInterval;

function startSignalingPolling() {
    // Poll for signaling messages every 1 second
    signalingPollInterval = setInterval(async () => {
        if (isCallActive && sessionID) {
            await pollSignalingMessages();
        }
    }, 1000);
}

function stopSignalingPolling() {
    if (signalingPollInterval) {
        clearInterval(signalingPollInterval);
        signalingPollInterval = null;
    }
}

async function pollSignalingMessages() {
    try {
        const response = await fetch(`/support/webrtc-signals/${sessionID}`);
        const data = await response.json();
        
        if (data.success && data.messages && data.messages.length > 0) {
            console.log('Customer received signaling messages:', data.messages);
            for (const message of data.messages) {
                await handleSignalingMessage(message);
            }
        }
    } catch (error) {
        console.error('Error polling customer signaling messages:', error);
    }
}

// Test WebRTC functionality for Render.com
async function testWebRTC() {
    console.log('🧪 WebRTC test başlatılıyor...');
    
    try {
        // Test 1: Check WebRTC support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('WebRTC getUserMedia desteklenmiyor');
        }
        console.log('✅ getUserMedia destekleniyor');
        
        // Test 2: Check RTCPeerConnection
        if (!window.RTCPeerConnection) {
            throw new Error('RTCPeerConnection desteklenmiyor');
        }
        console.log('✅ RTCPeerConnection destekleniyor');
        
        // Test 3: Create test peer connection
        const testPC = new RTCPeerConnection({
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        });
        console.log('✅ Test peer connection oluşturuldu');
        
        // Test 4: Check ICE gathering
        testPC.onicecandidate = (event) => {
            if (event.candidate) {
                console.log('✅ ICE candidate üretildi:', event.candidate.type);
            }
        };
        
        // Test 5: Create offer
        const offer = await testPC.createOffer();
        console.log('✅ Test offer oluşturuldu');
        
        // Cleanup
        testPC.close();
        console.log('✅ WebRTC test başarılı - Render.com uyumlu');
        
        return true;
        
    } catch (error) {
        console.error('❌ WebRTC test başarısız:', error);
        return false;
    }
}
</script>
{{end}} 