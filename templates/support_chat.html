{{template "base.html" .}}

{{define "content"}}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">
                                <i class="fas fa-comments me-2"></i>CanlÄ± Destek
                            </h4>
                            <small>SorularÄ±nÄ±z iÃ§in 7/24 buradayÄ±z!</small>
                        </div>
                        <div>
                            <button id="startVideoCallBtn" class="btn btn-success btn-lg" title="GÃ¶rÃ¼ntÃ¼lÃ¼ GÃ¶rÃ¼ÅŸmeye GeÃ§" style="font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.3); animation: pulse-glow 2s infinite;">
                                <i class="fas fa-video me-2"></i>ðŸ“ž GÃ¶rÃ¼ntÃ¼lÃ¼ GÃ¶rÃ¼ÅŸme
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- Video Call Area -->
                    <div id="videoCallArea" class="video-call-area" style="display: none; height: 300px; background: #000; position: relative;">
                        <video id="localVideo" autoplay muted style="width: 150px; height: 100px; position: absolute; top: 10px; right: 10px; border: 2px solid #fff; border-radius: 8px; z-index: 10;"></video>
                        <video id="remoteVideo" autoplay style="width: 100%; height: 100%; object-fit: cover;"></video>
                        <div id="videoCallControls" class="video-controls" style="position: absolute; bottom: 10px; right: 20px; z-index: 10; display: flex; flex-direction: row; gap: 10px;">
                            <button id="toggleMuteBtn" class="btn btn-secondary btn-sm" title="Mikrofonu AÃ§/Kapat">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button id="toggleVideoBtn" class="btn btn-secondary btn-sm" title="KamerayÄ± AÃ§/Kapat">
                                <i class="fas fa-video"></i>
                            </button>
                            <button id="endCallBtn" class="btn btn-danger btn-sm" title="GÃ¶rÃ¼ÅŸmeyi SonlandÄ±r">
                                <i class="fas fa-phone-slash"></i>
                            </button>
                        </div>
                        <div class="call-status" style="position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                            <i class="fas fa-circle text-success me-1" style="font-size: 8px;"></i>
                            <span id="callStatusText">BaÄŸlantÄ± kuruluyor...</span>
                        </div>
                    </div>
                    
                    <!-- Chat Messages Area -->
                    <div id="chatMessages" class="chat-messages" style="height: 400px; overflow-y: auto; padding: 20px; background: #f8f9fa;">
                        <div class="text-center text-muted">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>Merhaba! Size nasÄ±l yardÄ±mcÄ± olabiliriz?</p>
                            <div class="mt-3">
                                <button id="videoCallBtn2" class="btn btn-success btn-md" onclick="sendVideoCallRequest()" style="font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.2);">
                                    <i class="fas fa-video me-2"></i>ðŸ“ž HÄ±zlÄ± GÃ¶rÃ¼ntÃ¼lÃ¼ GÃ¶rÃ¼ÅŸme
                                </button>
                                <p class="mt-2 small text-muted">Mesaj yazmadan direkt gÃ¶rÃ¼ntÃ¼lÃ¼ gÃ¶rÃ¼ÅŸme baÅŸlatabilirsiniz!</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="chat-input border-top p-3">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." maxlength="500">
                            <button class="btn btn-primary" id="sendButton" type="button">
                                <i class="fas fa-paper-plane"></i> GÃ¶nder
                            </button>
                        </div>
                        <small class="text-muted">Enter tuÅŸuna basarak da mesaj gÃ¶nderebilirsiniz</small>
                    </div>
                </div>
            </div>
            
            <!-- Support Info -->
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Destek Saatleri:</strong> 7/24 online destek hizmeti veriyoruz. 
                MesajlarÄ±nÄ±z en kÄ±sa sÃ¼rede yanÄ±tlanacaktÄ±r.
            </div>
        </div>
    </div>
</div>

<style>
.chat-messages {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}

.message {
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.user {
    text-align: right;
}

.message.admin {
    text-align: left;
}

.message-bubble {
    display: inline-block;
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
    position: relative;
}

.message.user .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 4px;
}

.message.admin .message-bubble {
    background: white;
    color: #333;
    border: 1px solid #e0e0e0;
    border-bottom-left-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 5px;
}

.message.user .message-time {
    text-align: right;
    color: #fff;
}

.message.admin .message-time {
    text-align: left;
    color: #666;
}

.typing-indicator {
    text-align: left;
    margin-bottom: 15px;
}

.typing-bubble {
    display: inline-block;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 18px;
    padding: 12px 16px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}

.chat-input {
    background: white;
}

#messageInput:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Video Call Styles */
.video-call-area {
    border-bottom: 1px solid #dee2e6;
}

/* Video Call Button Animation */
@keyframes pulse-glow {
    0% {
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        transform: scale(1);
    }
    50% {
        box-shadow: 0 6px 16px rgba(40, 167, 69, 0.6);
        transform: scale(1.05);
    }
    100% {
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        transform: scale(1);
    }
}

/* Video Controls */
.video-controls button {
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.video-controls button.muted {
    background-color: #dc3545;
    border-color: #dc3545;
}

.video-controls button.video-off {
    background-color: #dc3545;
    border-color: #dc3545;
}
</style>

<script>
let sessionID = '{{.sessionID}}';
let lastMessageTime = null;
let pollInterval;

// Video Call Variables
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let isCallActive = false;
let isMuted = false;
let isVideoOff = false;

// DOM Elements
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const startVideoCallBtn = document.getElementById('startVideoCallBtn');
const videoCallArea = document.getElementById('videoCallArea');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const toggleMuteBtn = document.getElementById('toggleMuteBtn');
const toggleVideoBtn = document.getElementById('toggleVideoBtn');
const endCallBtn = document.getElementById('endCallBtn');
const callStatusText = document.getElementById('callStatusText');

// SessionID oluÅŸturma fonksiyonu
function generateSessionID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Initialize chat
document.addEventListener('DOMContentLoaded', function() {
    console.log('SessionID:', sessionID);
    
    // SessionID kontrolÃ¼ - eÄŸer boÅŸsa yeni oluÅŸtur
    if (!sessionID || sessionID === '') {
        sessionID = generateSessionID();
        console.log('New SessionID generated:', sessionID);
        document.cookie = `user_session=${sessionID}; path=/; max-age=${3600*24*30}`;
    }
    
    // Ä°lk ping'i hemen gÃ¶nder
    sendPing();
    
    loadMessages();
    startPolling();
    startSignalingPolling();
    
    // Event listeners
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    startVideoCallBtn.addEventListener('click', sendVideoCallRequest);
    
    if (toggleMuteBtn) {
        toggleMuteBtn.addEventListener('click', toggleMute);
    }
    if (toggleVideoBtn) {
        toggleVideoBtn.addEventListener('click', toggleVideo);
    }
    if (endCallBtn) {
        endCallBtn.addEventListener('click', endVideoCall);
    }
    
    messageInput.focus();
    
    // Start ping interval
    setInterval(sendPing, 15000);
});

// Load existing messages
function loadMessages() {
    fetch('/support/messages', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayMessages(data.messages);
        }
    })
    .catch(error => {
        console.error('Error loading messages:', error);
    });
}

// Send message
function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;
    
    messageInput.disabled = true;
    sendButton.disabled = true;
    
    fetch('/support/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            addMessage(data.message);
            scrollToBottom();
        } else {
            alert('Mesaj gÃ¶nderilemedi: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert('Mesaj gÃ¶nderilirken hata oluÅŸtu');
    })
    .finally(() => {
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    });
}

// Display messages
function displayMessages(messages) {
    chatMessages.innerHTML = '';
    
    if (messages && messages.length > 0) {
        messages.forEach(message => {
            addMessage(message);
        });
        scrollToBottom();
    } else {
        showWelcomeMessage();
    }
}

// Add message to chat
function addMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.sender === 'user' ? 'user' : 'admin'}`;
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.textContent = message.content;
    
    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = new Date(message.timestamp).toLocaleTimeString();
    
    messageDiv.appendChild(bubble);
    messageDiv.appendChild(time);
    chatMessages.appendChild(messageDiv);
    
    scrollToBottom();
}

// Show welcome message
function showWelcomeMessage() {
    chatMessages.innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-comments fa-3x mb-3"></i>
            <p>Merhaba! Size nasÄ±l yardÄ±mcÄ± olabiliriz?</p>
            <div class="mt-3">
                <button class="btn btn-success btn-md" onclick="sendVideoCallRequest()" style="font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.2);">
                    <i class="fas fa-video me-2"></i>ðŸ“ž HÄ±zlÄ± GÃ¶rÃ¼ntÃ¼lÃ¼ GÃ¶rÃ¼ÅŸme
                </button>
                <p class="mt-2 small text-muted">Mesaj yazmadan direkt gÃ¶rÃ¼ntÃ¼lÃ¼ gÃ¶rÃ¼ÅŸme baÅŸlatabilirsiniz!</p>
            </div>
        </div>
    `;
}

// Scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Start polling for new messages
function startPolling() {
    pollInterval = setInterval(() => {
        fetch('/support/messages', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.messages) {
                const newMessages = data.messages.filter(msg => 
                    !lastMessageTime || new Date(msg.timestamp) > lastMessageTime
                );
                
                if (newMessages.length > 0) {
                    newMessages.forEach(message => {
                        addMessage(message);
                    });
                    lastMessageTime = new Date(newMessages[newMessages.length - 1].timestamp);
                }
            }
        })
        .catch(error => {
            console.error('Error polling messages:', error);
        });
    }, 2000);
}

// Send ping to keep session alive
function sendPing() {
    fetch('/support/ping', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: sessionID,
            username: 'ZiyaretÃ§i'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Ping sent successfully');
        }
    })
    .catch(error => {
        console.error('Ping error:', error);
    });
}

// Video call functions
async function sendVideoCallRequest() {
    try {
        // Check if there's already a pending request
        const statusResponse = await fetch(`/support/video-call-status/${sessionID}`);
        const statusData = await statusResponse.json();
        
        if (statusData.success && statusData.has_request) {
            alert('Zaten aktif bir video arama talebiniz var. LÃ¼tfen bekleyin.');
            return;
        }
        
        const response = await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                action: 'start'
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Video call request failed:', data.error);
            alert('Video arama talebi gÃ¶nderilemedi: ' + data.error);
        } else {
            // Disable button
            startVideoCallBtn.disabled = true;
            startVideoCallBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Arama gÃ¶nderiliyor...';
            
            // Re-enable after 30 seconds
            setTimeout(() => {
                startVideoCallBtn.disabled = false;
                startVideoCallBtn.innerHTML = '<i class="fas fa-video me-2"></i>ðŸ“ž GÃ¶rÃ¼ntÃ¼lÃ¼ GÃ¶rÃ¼ÅŸme';
            }, 30000);
        }
    } catch (error) {
        console.error('Error sending video call request:', error);
        alert('Video arama talebi gÃ¶nderilemedi. LÃ¼tfen tekrar deneyin.');
    }
}

// Accept admin video call
async function acceptAdminCall() {
    try {
        // Remove modal
        if (window.adminCallModal) {
            document.body.removeChild(window.adminCallModal);
            window.adminCallModal = null;
        }
        
                // Check if MediaDevices API is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isSecure = window.location.protocol === 'https:';
            
            if (!isSecure && !isLocalhost) {
                throw new Error('Video gÃ¶rÃ¼ÅŸme Ã¶zelliÄŸi iÃ§in HTTPS gereklidir. LÃ¼tfen gÃ¼venli baÄŸlantÄ± Ã¼zerinden eriÅŸim saÄŸlayÄ±n.');
            } else {
                throw new Error('TarayÄ±cÄ±nÄ±z video gÃ¶rÃ¼ÅŸme Ã¶zelliÄŸini desteklemiyor. LÃ¼tfen farklÄ± bir tarayÄ±cÄ± kullanÄ±n.');
            }
        }
        
        // Get user media with fallback
        let stream;
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });
        } catch (mediaError) {
            // Try with audio only if video fails
            console.log('Video access failed, trying audio only:', mediaError);
            stream = await navigator.mediaDevices.getUserMedia({
                video: false,
                audio: true
            });
        }
        
        // Show local video
        localVideo.srcObject = stream;
        localVideo.style.display = 'block';
        
        // Show video call area
        videoCallArea.style.display = 'block';
        document.getElementById('videoCallControls').style.display = 'flex';
        startVideoCallBtn.style.display = 'none';
        
        // Adjust chat area height
        chatMessages.style.height = '300px';
        
        isCallActive = true;
        callStatusText.textContent = 'Video gÃ¶rÃ¼ÅŸme baÅŸlatÄ±lÄ±yor...';
        
        // Initialize WebRTC peer connection
        await initializePeerConnection();
        
        // Add local stream to peer connection
        stream.getTracks().forEach(track => {
            peerConnection.addTrack(track, stream);
        });
        
        // Start signaling polling
        startSignalingPolling();
        
        console.log('âœ… Video call accepted and started');
        
        // Send acceptance to admin
        await sendSignalingMessage({
            type: 'call-accepted'
        });
        
        // Update video call request status
        await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                action: 'accept'
            })
        });
        
    } catch (error) {
        console.error('Error accepting admin call:', error);
        
        let errorMessage = 'Video gÃ¶rÃ¼ÅŸme baÅŸlatÄ±lamadÄ±.';
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMessage = 'Kamera ve mikrofon eriÅŸimi saÄŸlanamadÄ±. LÃ¼tfen izinleri kontrol edin.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            errorMessage = 'Kamera veya mikrofon bulunamadÄ±. LÃ¼tfen cihazlarÄ±nÄ±zÄ± kontrol edin.';
        } else if (error.name === 'NotSupportedError') {
            errorMessage = 'TarayÄ±cÄ±nÄ±z video gÃ¶rÃ¼ÅŸme Ã¶zelliÄŸini desteklemiyor.';
        } else if (error.message.includes('HTTPS')) {
            errorMessage = error.message;
        } else {
            errorMessage += ' ' + error.message;
        }
        
        alert(errorMessage);
        
        // Send rejection to admin
        try {
            await sendSignalingMessage({
                type: 'call-rejected'
            });
            
            // Update video call request status
            await fetch('/support/video-call-request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: sessionID,
                    action: 'reject'
                })
            });
        } catch (rejectError) {
            console.error('Error rejecting call:', rejectError);
        }
    }
}

// Reject admin video call
async function rejectAdminCall() {
    try {
        // Remove modal
        if (window.adminCallModal) {
            document.body.removeChild(window.adminCallModal);
            window.adminCallModal = null;
        }
        
        // Send rejection to admin
        await sendSignalingMessage({
            type: 'call-rejected'
        });
        
        // Update video call request status
        await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                action: 'reject'
            })
        });
        
    } catch (error) {
        console.error('Error rejecting admin call:', error);
    }
}

// End video call
async function endVideoCall() {
    try {
        // Stop local stream
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        // Close peer connection
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        
        // Hide video call area
        videoCallArea.style.display = 'none';
        startVideoCallBtn.style.display = 'inline-block';
        
        // Reset chat area height
        chatMessages.style.height = '400px';
        
        // Reset video elements
        localVideo.srcObject = null;
        remoteVideo.srcObject = null;
        
        // Reset states
        isCallActive = false;
        isMuted = false;
        isVideoOff = false;
        
        // Stop signaling polling
        stopSignalingPolling();
        
        // Reset button states
        toggleMuteBtn.classList.remove('muted');
        toggleVideoBtn.classList.remove('video-off');
        toggleMuteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        toggleVideoBtn.innerHTML = '<i class="fas fa-video"></i>';
        
        // Send end call notification
        await sendVideoCallEnd();
        
        // Add system message
        addSystemMessage('Video gÃ¶rÃ¼ÅŸme sonlandÄ±rÄ±ldÄ±.');
        
    } catch (error) {
        console.error('Video call end error:', error);
    }
}

// Toggle mute
function toggleMute() {
    if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            isMuted = !audioTrack.enabled;
            
            if (isMuted) {
                toggleMuteBtn.classList.add('muted');
                toggleMuteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            } else {
                toggleMuteBtn.classList.remove('muted');
                toggleMuteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }
    }
}

// Toggle video
function toggleVideo() {
    if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            isVideoOff = !videoTrack.enabled;
            
            if (isVideoOff) {
                toggleVideoBtn.classList.add('video-off');
                toggleVideoBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
            } else {
                toggleVideoBtn.classList.remove('video-off');
                toggleVideoBtn.innerHTML = '<i class="fas fa-video"></i>';
            }
        }
    }
}

// Initialize WebRTC peer connection
async function initializePeerConnection() {
    try {
        console.log('Initializing peer connection...');
        
        peerConnection = new RTCPeerConnection({
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        });
        
        // Handle remote stream
        peerConnection.ontrack = (event) => {
            console.log('Received remote stream');
            remoteStream = event.streams[0];
            remoteVideo.srcObject = remoteStream;
            callStatusText.textContent = 'BaÄŸlantÄ± aktif';
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                sendSignalingMessage({
                    type: 'ice-candidate',
                    candidate: event.candidate
                });
            }
        };
        
        // Handle connection state changes
        peerConnection.onconnectionstatechange = () => {
            console.log('Connection state:', peerConnection.connectionState);
            switch (peerConnection.connectionState) {
                case 'connected':
                    callStatusText.textContent = 'BaÄŸlantÄ± aktif';
                    break;
                case 'disconnected':
                    callStatusText.textContent = 'BaÄŸlantÄ± kesildi';
                    break;
                case 'failed':
                    callStatusText.textContent = 'BaÄŸlantÄ± baÅŸarÄ±sÄ±z';
                    break;
            }
        };
        
        console.log('Peer connection initialized');
        
    } catch (error) {
        console.error('Peer connection initialization failed:', error);
    }
}

// Send signaling message
async function sendSignalingMessage(message) {
    try {
        const response = await fetch('/support/webrtc-signal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                message: message
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Signaling message failed:', data.error);
        }
    } catch (error) {
        console.error('Error sending signaling message:', error);
    }
}

// Handle incoming signaling messages
async function handleSignalingMessage(message) {
    try {
        console.log('Handling signaling message:', message);
        switch (message.type) {
            case 'offer':
                // Admin sent offer, create answer
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Send answer back to admin
                await sendSignalingMessage({
                    type: 'answer',
                    sdp: answer
                });
                break;
                
            case 'ice-candidate':
                // Add ICE candidate
                if (message.candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                }
                break;
                
            case 'call-ended':
                // Admin ended the call
                endVideoCall();
                break;
        }
    } catch (error) {
        console.error('Error handling signaling message:', error);
    }
}

// Send video call end
async function sendVideoCallEnd() {
    try {
        const response = await fetch('/support/video-call-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionID,
                action: 'end'
            })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Video call end failed:', data.error);
        }
    } catch (error) {
        console.error('Error sending video call end:', error);
    }
}

// Add system message
function addSystemMessage(content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message system';
    messageDiv.style.textAlign = 'center';
    messageDiv.style.margin = '10px 0';
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.style.background = '#f8f9fa';
    bubble.style.color = '#6c757d';
    bubble.style.border = '1px solid #dee2e6';
    bubble.style.fontSize = '0.9em';
    bubble.textContent = content;
    
    messageDiv.appendChild(bubble);
    chatMessages.appendChild(messageDiv);
    
    scrollToBottom();
}

// Signaling polling
let signalingPollInterval;

function startSignalingPolling() {
    signalingPollInterval = setInterval(async () => {
        if (sessionID) {
            await pollSignalingMessages();
        }
    }, 2000);
}

function stopSignalingPolling() {
    if (signalingPollInterval) {
        clearInterval(signalingPollInterval);
        signalingPollInterval = null;
    }
}

async function pollSignalingMessages() {
    try {
        const response = await fetch(`/support/webrtc-signals/${sessionID}`);
        const data = await response.json();
        
        if (data.success && data.messages && data.messages.length > 0) {
            console.log('Received signaling messages:', data.messages);
            for (const message of data.messages) {
                await handleSignalingMessage(message);
            }
        }
    } catch (error) {
        console.error('Error polling signaling messages:', error);
        stopSignalingPolling();
    }
}

// Check for admin video call requests
async function checkVideoCallStatus() {
    try {
        const response = await fetch(`/support/video-call-status/${sessionID}`);
        const data = await response.json();
        
        if (data.success && data.has_request && data.request.status === 'pending') {
            // Show admin call modal
            showAdminCallModal(data.request);
        }
    } catch (error) {
        console.error('Error checking video call status:', error);
    }
}

// Show admin call modal
function showAdminCallModal(request) {
    // Remove existing modal
    if (window.adminCallModal) {
        document.body.removeChild(window.adminCallModal);
    }
    
    // Create modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 10px; padding: 30px; max-width: 400px; width: 100%; text-align: center;">
            <i class="fas fa-video" style="font-size: 48px; color: #007bff; margin-bottom: 20px;"></i>
            <h4 style="color: #333; margin-bottom: 15px;">Video Arama</h4>
            <p style="color: #666; margin-bottom: 25px;">Admin video arama talebinizi kabul etti. GÃ¶rÃ¼ÅŸmeye baÅŸlamak istiyor musunuz?</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="acceptAdminCall()" style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 16px;
                ">BaÅŸlat</button>
                <button onclick="rejectAdminCall()" style="
                    background: #dc3545;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 16px;
                ">Ä°ptal</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    window.adminCallModal = modal;
}

// Check video call status periodically
setInterval(checkVideoCallStatus, 5000);

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (pollInterval) {
        clearInterval(pollInterval);
    }
    if (signalingPollInterval) {
        clearInterval(signalingPollInterval);
    }
    
    // Send leave notification
    fetch('/support/leave', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: sessionID
        })
    }).catch(error => {
        console.error('Error sending leave notification:', error);
    });
});
</script>
{{end}} 